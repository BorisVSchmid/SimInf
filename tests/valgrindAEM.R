library(SimInf)
##library(ggplot2)
##library(reshape2)

SIRresult <- function(inits = c(99,1,0),beta = 0.16, gamma = 0.077, seed = 22, threads = 1, plotResult = F){
    u0 <- data.frame(S=inits[1], I = inits[2], R = inits[3])
    tspan <-  seq(1,6*30,by=7)
    model <- SIR(u0 = u0, tspan = tspan, beta = beta, gamma = gamma)
    ##model <- demo_model(nodes = 1, days = 1000, model = "SISe")
    
    result <- run(model,threads = threads, seed = seed)

    if(plotResult)
        plot(result, N  =TRUE, spaghetti = TRUE, compartments = c("S","I","R"))

    return(result)
}

### Plot the difference between two runs, where one parameter is
### assumed to be pertubed by a small amount delta.
AEMdiff <- function(run1, run2){
    ## assumed same tspan vector
    tspan <- run1@tspan
    S1 <- c(infected(run1))
    S2 <- c(infected(run2))

    df <- data.frame(t=tspan, S1 = S1, S2 = S2)
    df.m <- melt(df,id="t")

    p <- ggplot(df.m,aes(x=t,y=value,colour=variable,group=variable)) + geom_line()
    ##p <- ggplot(df,aes(t, value, colour = variable)) + geom_line()
    p
    ## plot(x=tspan,y=S1,type="l",colous="red")
    ## par(new = TRUE)
    ## plot(x=tspan,y=S2,type="l",colour="blue")
}


SISe3spDemo <- function(){
    ## load data
    data("u0_SISe3",package = "SimInf")
    data("events_SISe3", package = "SimInf")
    data("nodes", package = "SimInf")

    ## distance matrix
    d <- distance_matrix(x = nodes$x, y = nodes$y, cutoff = 2500)

    ## tspan
    tspan <- seq(1,4*365, by= 7)

    ## initialize 
    set.seed(123)
    i <- sample(1:1600,160)

    u0_SISe3$I_1[i] <- as.integer(u0_SISe3$S_1[i] * 0.05)
    u0_SISe3$I_2[i] <- as.integer(u0_SISe3$S_2[i] * 0.05)
    u0_SISe3$I_3[i] <- as.integer(u0_SISe3$S_3[i] * 0.05)
    u0_SISe3$S_1[i] <- u0_SISe3$S_1[i] - u0_SISe3$I_1[i]
    u0_SISe3$S_2[i] <- u0_SISe3$S_2[i] - u0_SISe3$I_2[i]
    u0_SISe3$S_3[i] <- u0_SISe3$S_3[i] - u0_SISe3$I_3[i]

    ## construct SISe3_sp model object
    model <- SISe3_sp(u0 = u0_SISe3, tspan = tspan, phi = rep(0,1600),
                      events = events_SISe3, upsilon_1 = 0.013, upsilon_2 = 0.013,
                      upsilon_3 = 0.013, gamma_1 = 0.1, gamma_2 = 0.1, gamma_3 = 0.1, alpha = 1,
                      beta_t1 = 0.095, beta_t2 = 0.012, beta_t3 = 0.1, beta_t4 = 0.15,
                      end_t1 = 91, end_t2 = 182, end_t3 = 273, end_t4 = 365, distance = d,
                      coupling = 0.1)

    return(model)
    ## run model
    ##result <- run(model, threads = 1, seed = 1)
}

runmodel <- function(threads=1){
    m <- SISe3spDemo()
    res <- run(m, threads=threads)
}



SISe3spPlotN <- function(result){
    N1 <- colSums(susceptible(result, age = 1) + infected(result, age = 1))
    N2 <- colSums(susceptible(result, age = 2) + infected(result, age = 2))
    N3 <- colSums(susceptible(result, age = 3) + infected(result, age = 3))
    opar <- par(mfrow = c(3,1), mar = c(2,5,1,1))
    plot(N3 ~tspan, ylab = "N", type = "l", bty = "l", lty = 1)
    plot(N2 ~tspan, ylab = "N", type = "l", bty = "l", lty = 2)
    plot(N1 ~tspan, ylab = "N", type = "l", bty = "l", lty = 3)
    mtext("Day", side = 1, line = 1, at = 750)
    par(opar)
}

modelParser <- function(){
    transitions <-  c("S -> b*S*I/(S+I+R) -> I", "I -> g*I -> R")
    compartments <- c("S","I","R")

    m <- mparse(transitions, compartments, b= 0.16, g= 0.077)
    model <- init(m, u0 = cbind(S = 99, I = 1, R = 0), tspan = 1:180)

    result <- run(model, threads = 1, seed = 22)
    return(list(model,result))
}

SIRextended2 <- function(){
    u0 <- data.frame(S = c(90,100,100,100,100), I = c(10,0,0,0,0), R = c(0,0,0,0,0))
    events <- data.frame(event      = c(3,3,3,3),
                         time       = c(3,25,5,10),
                         node       = c(1,1,1,1),
                         dest       = c(3,2,3,3),
                         n          = c(1,9,1,5),
                         proportion = c(0,0,0,0),
                         select     = c(2,2,2,2),
                         shift      = c(0,0,0,0))
    model <- SIR(u0, 1:75, events = events, beta = 0.16, gamma = 0.077)
    res <- run(model,threads = 1, seed = 5)
}

SIRextended <- function(){
    u0 <- data.frame(S = c(90,100,100,100,100), I = c(10,0,0,0,0), R = c(0,0,0,0,0))
    events <- data.frame(event      = c(3,3,3,3),
                         time       = c(3,25,5,10),
                         node       = c(1,1,1,1),
                         dest       = c(3,2,3,3),
                         n          = c(1,9,1,5),
                         proportion = c(0,0,0,0),
                         select     = c(2,2,2,2),
                         shift      = c(0,0,0,0))
    model <- SIR(u0, 1:75, events = events, beta = 0.16, gamma = 0.077)
    res <- run(model,threads = 1, seed = 5)
}
    


## test script
##SIRresult()
##runmodel(1)
## runmodel(2)
## runmodel()
SIRextended()


